<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use DB;
class AppCtrl extends Controller
{
    protected $cari = [
        '0574400003',
        '0624400002',
        '0484400006',
        '0494400003',
        '0354400001',
        '0734400001',
        '0404400003',
        '0434400004',
        '0424400007',
        '0314400004',
        '0114400009',
        '0604400019',
        '0824400003',
        '0064400005',
        '0064400008',
        '0064400006',
        '0714400006',
        '0684400003',
        '0424400006',
        '0394400014',
        '0394400015',
        '0864400014',
        '0864400015',
        '0594400006',
        '0594400008',
        '0594400005',
        '0594400007',
        '0594400009',
        '0554400002',
        '0994400003',
        '0994400005',
        '0674400005',
        '0354400005',
        '0644400012',
        '0244400006',
        '0264400010',
        '0244400005',
        '0244400007',
        '0244400008',
        '0264400006',
        '0264400011',
        '0264400007',
        '0264400005',
        '0924400002',
        '0744400013',
        '0454400008',
        '0634400013',
        '0204400005',
        '0204400006',
        '0394400006',
        '0394400007',
        '0394400004',
        '0394400012',
        '0394400011',
        '0394400010',
        '0394400013',
        '0394400008',
        '0604400022',
        '0974400012',
        '0674400006',
        '0674400004',
        '0614400020',
        '0614400019',
        '0064400007',
        '0684400018',
        '0264400008',
        '0224400003',
        '0744400014',
        '0224400002',
        '0224400008',
        '0224400005',
        '0224400010',
        '0224400012',
        '0224400014'
    ];
    protected $cari2 = [
        "1034400004",
        "0894400005",
        "0714400001",
        "0824400007",
        "0614400012",
        "0524400001",
        "0534400005",
        "0454400007",
        "0964400004",
        "0134400003"
    ];

    protected $cari3 = [
        "0634400020",
        "0634400022",
        "0634400023",
        "0634400027",
        "0634400026",
        "0634400024",
        "0644400022",
        "0644400023",
        "0644400024",
        "0644400003",
        "0644400002",
        "0644400011",
        "0864400020",
        "0764400001",
        "0854400002",
        "0444400002",
        "1054400008",
        "0644400015",
        "0724400002",
        "0994400002"
    ];
    public function saldo(){
        try {
            $data = DB::table('SHDBLC')->whereIn('noac',$this->cari3)->where('sldakhir','>',0)->get();
            $contents = file_get_contents(public_path('mutasi/1.json'));
            $data_ubah = json_decode($contents,true);
            $arr = array();
            $success = array();
            $errors = array();
            // dd($data_ubah);
            $i = 0;
            foreach ($data as $k => $v){
                $noac = trim($v->noac);
                if (isset($data_ubah[$noac])) {
                    $arr[$noac] = $data_ubah[$noac];
                    DB::select('exec sp_pinbuk_biaya ?, ?, ?, ?, ?, ?, ?',array($noac,$arr[$noac],$v->sldakhir,"TR3", "SYS", "MUTASI KARYAWAN", 0));
                    $success[$k]['noac'] = $noac;
                    $success[$k]['saldo'] = $v->sldakhir;
                }else{
                    $errors[$k]['noac'] = $noac;
                    $errors[$k]['saldo'] = $v->sldakhir;
                }
                $i++;
                // print($v->noac)."<br>";
            }

            return response()->json(['data'=>$success,'i'=>$i]);
        } catch (\Exception $e) {
            return response()->json($e->getMessage());
        }
        
    }
}
